USE [master]
GO
-- 1. Tạo cơ sở dữ liệu

DROP DATABASE IF EXISTS [QLTV74];
GO

CREATE DATABASE [QLTV74]
 CONTAINMENT = NONE
 ON  PRIMARY 
( NAME = N'QLTV74', FILENAME = N'D:\QLTV74.mdf' , SIZE = 4096KB , MAXSIZE = UNLIMITED, FILEGROWTH = 1024KB )
 LOG ON 
( NAME = N'QLTV74_log', FILENAME = N'D:\QLTV74_log.ldf' , SIZE = 3456KB , MAXSIZE = UNLIMITED, FILEGROWTH = 10%)
 WITH CATALOG_COLLATION = DATABASE_DEFAULT
GO
ALTER DATABASE [QLTV74] SET COMPATIBILITY_LEVEL = 100
GO
IF (1 = FULLTEXTSERVICEPROPERTY('IsFullTextInstalled'))
begin
EXEC [QLTV74].[dbo].[sp_fulltext_database] @action = 'enable'
end
GO
ALTER DATABASE [QLTV74] SET ANSI_NULL_DEFAULT OFF 
GO
ALTER DATABASE [QLTV74] SET ANSI_NULLS OFF 
GO
ALTER DATABASE [QLTV74] SET ANSI_PADDING OFF 
GO
ALTER DATABASE [QLTV74] SET ANSI_WARNINGS OFF 
GO
ALTER DATABASE [QLTV74] SET ARITHABORT OFF 
GO
ALTER DATABASE [QLTV74] SET AUTO_CLOSE OFF 
GO
ALTER DATABASE [QLTV74] SET AUTO_SHRINK OFF 
GO
ALTER DATABASE [QLTV74] SET AUTO_UPDATE_STATISTICS ON 
GO
ALTER DATABASE [QLTV74] SET CURSOR_CLOSE_ON_COMMIT OFF 
GO
ALTER DATABASE [QLTV74] SET CURSOR_DEFAULT  GLOBAL 
GO
ALTER DATABASE [QLTV74] SET CONCAT_NULL_YIELDS_NULL OFF 
GO
ALTER DATABASE [QLTV74] SET NUMERIC_ROUNDABORT OFF 
GO
ALTER DATABASE [QLTV74] SET QUOTED_IDENTIFIER OFF 
GO
ALTER DATABASE [QLTV74] SET RECURSIVE_TRIGGERS OFF 
GO
ALTER DATABASE [QLTV74] SET  DISABLE_BROKER 
GO
ALTER DATABASE [QLTV74] SET AUTO_UPDATE_STATISTICS_ASYNC OFF 
GO
ALTER DATABASE [QLTV74] SET DATE_CORRELATION_OPTIMIZATION OFF 
GO
ALTER DATABASE [QLTV74] SET TRUSTWORTHY OFF 
GO
ALTER DATABASE [QLTV74] SET ALLOW_SNAPSHOT_ISOLATION OFF 
GO
ALTER DATABASE [QLTV74] SET PARAMETERIZATION SIMPLE 
GO
ALTER DATABASE [QLTV74] SET READ_COMMITTED_SNAPSHOT OFF 
GO
ALTER DATABASE [QLTV74] SET HONOR_BROKER_PRIORITY OFF 
GO
ALTER DATABASE [QLTV74] SET RECOVERY SIMPLE 
GO
ALTER DATABASE [QLTV74] SET  MULTI_USER 
GO
ALTER DATABASE [QLTV74] SET PAGE_VERIFY CHECKSUM  
GO
ALTER DATABASE [QLTV74] SET DB_CHAINING OFF 
GO
ALTER DATABASE [QLTV74] SET FILESTREAM( NON_TRANSACTED_ACCESS = OFF ) 
GO
ALTER DATABASE [QLTV74] SET TARGET_RECOVERY_TIME = 0 SECONDS 
GO
ALTER DATABASE [QLTV74] SET DELAYED_DURABILITY = DISABLED 
GO
ALTER DATABASE [QLTV74] SET ACCELERATED_DATABASE_RECOVERY = OFF  
GO
EXEC sys.sp_db_vardecimal_storage_format N'QLTV74', N'ON'
GO
ALTER DATABASE [QLTV74] SET QUERY_STORE = OFF
GO
USE [QLTV74]
GO

CREATE USER [us23] WITHOUT LOGIN WITH DEFAULT_SCHEMA=[us23]
GO
CREATE USER [admin] WITHOUT LOGIN WITH DEFAULT_SCHEMA=[dbo]
GO
CREATE SCHEMA [us23]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- 2. Tạo bảng DAUSACH
CREATE TABLE DAUSACH (
    MADAUSACH CHAR(10) NOT NULL PRIMARY KEY,
    TENSACH NVARCHAR(100) NOT NULL,
    TENTACGIA NVARCHAR(100) NOT NULL,
    THELOAI NVARCHAR(50) NULL,
    NAMXB INT NOT NULL,
    NXB NVARCHAR(100) NOT NULL,
    NDTOMTAT TEXT NULL,
    NGONNGU NVARCHAR(50) NULL,
    SOLUONG INT NOT NULL
);

-- 3. Tạo bảng SACH
CREATE TABLE SACH (
    MASACH CHAR(10) NOT NULL PRIMARY KEY,
    MADAUSACH CHAR(10) NOT NULL,
    TINHTRANG NVARCHAR(50) NOT NULL,
    VITRI NVARCHAR(100) NULL,
    FOREIGN KEY (MADAUSACH) REFERENCES DAUSACH(MADAUSACH)
);

-- 4. Tạo bảng DOCGIA
CREATE TABLE DOCGIA (
    MADG CHAR(10) NOT NULL PRIMARY KEY,
    TENDG NVARCHAR(100) NOT NULL,
    NGAYSINH DATE NOT NULL,
    GT NVARCHAR(10) NOT NULL,
    DIACHI NVARCHAR(200) NULL
);

-- 5. Tạo bảng PHIEUMUON
CREATE TABLE PHIEUMUON (
    MAPM CHAR(10) NOT NULL PRIMARY KEY,
    MADG CHAR(10) NOT NULL,
    NGAYMUON DATE NOT NULL,
    NGAYDKTRA DATE NOT NULL,
    MANV CHAR(10) NULL,
    TRANGTHAI NVARCHAR(50) NOT NULL DEFAULT 'Đang mượn',
    FOREIGN KEY (MADG) REFERENCES DOCGIA(MADG)
);

-- 6. Tạo bảng MUONTRA
CREATE TABLE MUONTRA (
    MAMT CHAR(10) NOT NULL PRIMARY KEY,
    MAPM CHAR(10) NOT NULL,
    MASACH CHAR(10) NOT NULL,
    NGAYTRA DATE NULL,
    FOREIGN KEY (MAPM) REFERENCES PHIEUMUON(MAPM),
    FOREIGN KEY (MASACH) REFERENCES SACH(MASACH)
);

-- 7. Tạo bảng NHANVIEN
CREATE TABLE NHANVIEN (
    MANV CHAR(10) NOT NULL PRIMARY KEY,
    TENNV NVARCHAR(100) NOT NULL,
    CHUCVU NVARCHAR(50) NOT NULL,
    DIENTHOAI NVARCHAR(15) NULL,
    EMAIL NVARCHAR(100) NULL,
    NGAYVAOLAM DATE NOT NULL
);

-- 8. Tạo bảng PHAT
CREATE TABLE PHAT (
    MAPHAT CHAR(10) NOT NULL PRIMARY KEY,
    MADG CHAR(10) NOT NULL,
    MASACH CHAR(10) NOT NULL,
    LYDOPHAT NVARCHAR(200) NOT NULL,
    SOTIENPHAT DECIMAL(10, 2) NOT NULL,
    NGAYPHAT DATE NOT NULL,
    TRANGTHAI NVARCHAR(50) NULL,
    FOREIGN KEY (MADG) REFERENCES DOCGIA(MADG),
    FOREIGN KEY (MASACH) REFERENCES SACH(MASACH)
);

-- 9. Tạo bảng NGUOIDUNG
CREATE TABLE NGUOIDUNG (
    TENDANGNHAP NVARCHAR(50) NOT NULL PRIMARY KEY,
    MATKHAU NVARCHAR(100) NOT NULL,
    LOAI INT NOT NULL,
    MANV CHAR(10) NULL,
    MADG CHAR(10) NULL,
    FOREIGN KEY (MANV) REFERENCES NHANVIEN(MANV),
    FOREIGN KEY (MADG) REFERENCES DOCGIA(MADG)
);

-- 10. Tạo bảng THE
CREATE TABLE THE (
    MATHE CHAR(10) NOT NULL PRIMARY KEY,
    MADG CHAR(10) NOT NULL,
    NGAYCAP DATE NOT NULL,
    NGAYHETHAN DATE NOT NULL,
    TRANGTHAI NVARCHAR(50) NOT NULL DEFAULT 'Còn hiệu lực',
    FOREIGN KEY (MADG) REFERENCES DOCGIA(MADG)
);

-- 11. Tạo bảng HOADON
CREATE TABLE HOADON (
    MAHD CHAR(10) NOT NULL PRIMARY KEY,
    NGAYHD DATE NOT NULL,
    MANV CHAR(10) NULL,
    MADG CHAR(10) NULL,
    TONGTIEN DECIMAL(10, 2) NOT NULL,
    FOREIGN KEY (MANV) REFERENCES NHANVIEN(MANV),
    FOREIGN KEY (MADG) REFERENCES DOCGIA(MADG)
);

-- 12. Tạo bảng DANGKYMUON
CREATE TABLE DANGKYMUON (
    MADK CHAR(10) NOT NULL PRIMARY KEY,
    MADG CHAR(10) NOT NULL,
    MASACH CHAR(10) NOT NULL,
    NGAYDANGKY DATE NOT NULL,
    TRANGTHAI NVARCHAR(50) NOT NULL DEFAULT 'Chờ xử lý',
    FOREIGN KEY (MADG) REFERENCES DOCGIA(MADG),
    FOREIGN KEY (MASACH) REFERENCES SACH(MASACH)
);


-- 1. Bảng DAUSACH
INSERT INTO DAUSACH (MADAUSACH, TENSACH, TENTACGIA, THELOAI, NAMXB, NXB, NDTOMTAT, NGONNGU, SOLUONG)
VALUES 
('DS001', 'Lập Trình C#', 'Nguyễn Văn A', 'Công Nghệ', 2020, 'NXB Giáo Dục', 'Sách về lập trình C# cơ bản', 'Tiếng Việt', 10),
('DS002', 'Data Science', 'John Doe', 'Khoa Học', 2019, 'O’Reilly Media', 'Introduction to Data Science', 'English', 5),
('DS003', 'Thuật Toán', 'Nguyễn Thị B', 'Tin Học', 2018, 'NXB Khoa Học', 'Giới thiệu thuật toán cơ bản', 'Tiếng Việt', 8);

-- 2. Bảng SACH
INSERT INTO SACH (MASACH, MADAUSACH, TINHTRANG, VITRI)
VALUES 
('S001', 'DS001', 'Còn mới', 'Kệ A1'),
('S002', 'DS001', 'Đã cũ', 'Kệ A2'),
('S003', 'DS002', 'Còn mới', 'Kệ B1'),
('S004', 'DS003', 'Hỏng nhẹ', 'Kệ C1');

-- 3. Bảng DOCGIA
INSERT INTO DOCGIA (MADG, TENDG, NGAYSINH, GT, DIACHI)
VALUES 
('DG001', 'Trần Văn C', '1990-05-10', 'Nam', 'Hà Nội'),
('DG002', 'Lê Thị D', '1985-09-15', 'Nữ', 'TP. Hồ Chí Minh'),
('DG003', 'Phạm Minh E', '2000-03-20', 'Nam', 'Đà Nẵng');

-- 4. Bảng PHIEUMUON
INSERT INTO PHIEUMUON (MAPM, MADG, NGAYMUON, NGAYDKTRA, MANV, TRANGTHAI)
VALUES 
('PM001', 'DG001', '2024-12-01', '2024-12-15', 'NV001', 'Đang mượn'),
('PM002', 'DG002', '2024-12-05', '2024-12-20', 'NV002', 'Đang mượn');

-- 5. Bảng MUONTRA
INSERT INTO MUONTRA (MAMT, MAPM, MASACH, NGAYTRA)
VALUES 
('MT001', 'PM001', 'S001', NULL),
('MT002', 'PM002', 'S003', '2024-12-09');

-- 6. Bảng NHANVIEN
INSERT INTO NHANVIEN (MANV, TENNV, CHUCVU, DIENTHOAI, EMAIL, NGAYVAOLAM)
VALUES 
('NV001', 'Nguyễn Văn F', 'Thủ thư', '0123456789', 'nvf@example.com', '2020-01-15'),
('NV002', 'Trần Thị G', 'Thủ thư', '0987654321', 'ttg@example.com', '2021-06-10');

-- 7. Bảng PHAT
INSERT INTO PHAT (MAPHAT, MADG, MASACH, LYDOPHAT, SOTIENPHAT, NGAYPHAT, TRANGTHAI)
VALUES 
('PH001', 'DG001', 'S001', 'Trả sách trễ', 50000, '2024-12-08', 'Đã xử lý'),
('PH002', 'DG002', 'S003', 'Làm hỏng sách', 150000, '2024-12-09', 'Chưa xử lý');

-- 8. Bảng NGUOIDUNG
INSERT INTO NGUOIDUNG (TENDANGNHAP, MATKHAU, LOAI, MANV, MADG)
VALUES 
('admin', 'admin123', 1, 'NV001', NULL),
('dg_lethid', 'password123', 2, NULL, 'DG002');

-- 9. Bảng THE
INSERT INTO THE (MATHE, MADG, NGAYCAP, NGAYHETHAN, TRANGTHAI)
VALUES 
('TH001', 'DG001', '2023-01-01', '2025-01-01', 'Còn hiệu lực'),
('TH002', 'DG002', '2023-06-01', '2025-06-01', 'Còn hiệu lực');

-- 10. Bảng HOADON
INSERT INTO HOADON (MAHD, NGAYHD, MANV, MADG, TONGTIEN)
VALUES 
('HD001', '2024-12-01', 'NV001', 'DG001', 50000),
('HD002', '2024-12-08', 'NV002', 'DG002', 150000);

-- 11. Bảng DANGKYMUON
INSERT INTO DANGKYMUON (MADK, MADG, MASACH, NGAYDANGKY, TRANGTHAI)
VALUES 
('DK001', 'DG001', 'S002', '2024-12-01', 'Chờ xử lý'),
('DK002', 'DG003', 'S004', '2024-12-07', 'Đã xử lý');





